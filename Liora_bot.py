import os
import random
import telebot
from telebot import types

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç —Å—Ä–µ–¥–∞—Ç–∞ (Render ‚Üí Environment) ===
BOT_TOKEN = os.getenv("BOT_TOKEN")
PROVIDER_TOKEN = os.getenv("PROVIDER_TOKEN")  # –∑–∞ –ø–ª–∞—Ç–µ–Ω–∏—Ç–µ —É—Å–ª—É–≥–∏

if not BOT_TOKEN:
    raise RuntimeError("–õ–∏–ø—Å–≤–∞ BOT_TOKEN (Render ‚Üí Environment ‚Üí BOT_TOKEN).")

if not PROVIDER_TOKEN:
    # –ú–æ–∂–µ–º –¥–∞ –ø–æ–∑–≤–æ–ª–∏–º –±–æ—Ç—ä—Ç –¥–∞ —Ä–∞–±–æ—Ç–∏ –∏ –±–µ–∑ –ø–ª–∞—â–∞–Ω–∏—è,
    # –Ω–æ –∑–∞ –º–æ–º–µ–Ω—Ç–∞ –∏—Å–∫–∞–º–µ –¥–∞ –≥–∏ –ø–æ–ª–∑–≤–∞–º–µ:
    raise RuntimeError("–õ–∏–ø—Å–≤–∞ PROVIDER_TOKEN (Render ‚Üí Environment ‚Üí PROVIDER_TOKEN).")

bot = telebot.TeleBot(BOT_TOKEN)

# === –î–∞–Ω–Ω–∏ –∑–∞ —Ö–æ—Ä–æ—Å–∫–æ–ø–∏—Ç–µ ===

ZODIAC_SIGNS = [
    "–û–≤–µ–Ω", "–¢–µ–ª–µ—Ü", "–ë–ª–∏–∑–Ω–∞—Ü–∏", "–†–∞–∫",
    "–õ—ä–≤", "–î–µ–≤–∞", "–í–µ–∑–Ω–∏", "–°–∫–æ—Ä–ø–∏–æ–Ω",
    "–°—Ç—Ä–µ–ª–µ—Ü", "–ö–æ–∑–∏—Ä–æ–≥", "–í–æ–¥–æ–ª–µ–π", "–†–∏–±–∏"
]

# –ö—Ä–∞—Ç–∫–∏ –±–µ–∑–ø–ª–∞—Ç–Ω–∏ –ø–æ—Å–ª–∞–Ω–∏—è –∑–∞ –¥–µ–Ω—è
DAILY_MESSAGES = {
    "–û–≤–µ–Ω": [
        "üî• –û–≤–µ–Ω, –¥–Ω–µ—Å –¥–µ–π—Å—Ç–≤–∞–π —Å–º–µ–ª–æ ‚Äì –Ω–æ —Å —É—Å–º–∏–≤–∫–∞, –Ω–µ —Å—ä—Å —Å–∞–±—è.",
        "‚ú® –ú–∞–ª–∫–æ —Ç—ä—Ä–ø–µ–Ω–∏–µ –¥–Ω–µ—Å —â–µ —Ç–∏ —Å–ø–µ—Å—Ç–∏ –º–Ω–æ–≥–æ –¥—Ä–∞–º–∞ —É—Ç—Ä–µ."
    ],
    "–¢–µ–ª–µ—Ü": [
        "üåø –¢–µ–ª–µ—Ü, –ø–æ–≥—Ä–∏–∂–∏ —Å–µ –∑–∞ —Ç—è–ª–æ—Ç–æ —Å–∏ ‚Äì —Ç–æ –µ –¥–æ–º –Ω–∞ –¥—É—à–∞—Ç–∞ —Ç–∏.",
        "üíö –ú–∞–ª–∫–∏ —Ä–∞–¥–æ—Å—Ç–∏ –¥–Ω–µ—Å —â–µ —Ç–∏ –¥–æ–Ω–µ—Å–∞—Ç –≥–æ–ª—è–º–æ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ."
    ],
    "–ë–ª–∏–∑–Ω–∞—Ü–∏": [
        "üí´ –ë–ª–∏–∑–Ω–∞—Ü–∏, –¥—É–º–∏—Ç–µ —Ç–∏ –¥–Ω–µ—Å –º–æ–≥–∞—Ç –¥–∞ —Å—Ç–æ–ø–ª—è—Ç –Ω–µ—á–∏–µ —Å—ä—Ä—Ü–µ.",
        "üß† –ò–¥–µ—è, –∫–æ—è—Ç–æ —Ç–∏ –º–∏–Ω–∞–≤–∞ –ø—Ä–µ–∑ —É–º–∞ –¥–Ω–µ—Å, –∑–∞—Å–ª—É–∂–∞–≤–∞ –¥–∞ –±—ä–¥–µ –∑–∞–ø–∏—Å–∞–Ω–∞."
    ],
    "–†–∞–∫": [
        "üåô –†–∞–∫, –ø–æ–∑–≤–æ–ª–∏ —Å–∏ –¥–∞ –±—ä–¥–µ—à —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–Ω–∞ ‚Äì —Ç–æ–≤–∞ –µ —Ç–≤–æ—è—Ç–∞ —Å–∏–ª–∞.",
        "üè° –î–æ–º—ä—Ç —Ç–∏ –¥–Ω–µ—Å –µ —Ç–≤–æ—è –º–∞–ª—ä–∫ —Ö—Ä–∞–º. –ü–æ–¥—Ä–µ–¥–∏ –≥–æ, –∫–∞–∫—Ç–æ –∏ –º–∏—Å–ª–∏—Ç–µ —Å–∏."
    ],
    "–õ—ä–≤": [
        "ü¶Å –õ—ä–≤, –Ω–µ –∑–∞–±—Ä–∞–≤—è–π: –±–ª–µ—Å—Ç–∏—à –∏ –±–µ–∑ –ø—Ä–æ–∂–µ–∫—Ç–æ—Ä–∏.",
        "üåû –î–Ω–µ—Å –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç –æ—Ç —Ç–µ–± —â–µ –Ω–∞–ø—Ä–∞–≤–∏ —á—É–¥–µ—Å–∞ –∑–∞ –Ω—è–∫–æ–≥–æ."
    ],
    "–î–µ–≤–∞": [
        "üìö –î–µ–≤–∞, –æ—Å—Ç–∞–≤–∏ –¥–µ—Ç–∞–π–ª–∏—Ç–µ –¥–∞ —Å–∏ –ø–æ—á–∏–Ω–∞—Ç. –ü–µ—Ä—Ñ–µ–∫—Ç–Ω–æ—Ç–æ –Ω–µ –≤–∏–Ω–∞–≥–∏ –µ –Ω—É–∂–Ω–æ.",
        "üßπ –ú–∞–ª–∫–æ –ø–æ–¥—Ä–µ–∂–¥–∞–Ω–µ –æ—Ç–≤—ä–Ω —â–µ –æ—Ç–ø—É—à–∏ –µ–Ω–µ—Ä–≥–∏—è—Ç–∞ –æ—Ç–≤—ä—Ç—Ä–µ."
    ],
    "–í–µ–∑–Ω–∏": [
        "‚öñÔ∏è –í–µ–∑–Ω–∏, –±–∞–ª–∞–Ω—Å—ä—Ç –¥–Ω–µ—Å –µ –º–µ–∂–¥—É ‚Äû–¥–∞‚Äú –∑–∞ –¥—Ä—É–≥–∏—Ç–µ –∏ ‚Äû–¥–∞‚Äú –∑–∞ —Ç–µ–±.",
        "üíñ –†–∞–∑–≥–æ–≤–æ—Ä –æ—Ç —Å—ä—Ä—Ü–µ —â–µ –∏–∑—Ä–∞–≤–Ω–∏ –≤–µ–∑–Ω–∏—Ç–µ."
    ],
    "–°–∫–æ—Ä–ø–∏–æ–Ω": [
        "ü¶Ç –°–∫–æ—Ä–ø–∏–æ–Ω, —Ç–≤–æ—è—Ç–∞ –∏–Ω—Ç—É–∏—Ü–∏—è –¥–Ω–µ—Å –µ –ø–æ-—Å–∏–ª–Ω–∞ –æ—Ç –≤—Å—è–∫–∞–∫–≤–∏ —Ñ–∞–∫—Ç–∏.",
        "üî• –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è—Ç–∞ –Ω–µ –µ —Å—Ç—Ä–∞—à–Ω–∞ ‚Äì —Ç—è –µ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ."
    ],
    "–°—Ç—Ä–µ–ª–µ—Ü": [
        "üèπ –°—Ç—Ä–µ–ª–µ—Ü, –∑–∞–º–∞—Ö–Ω–∏ —Å–º–µ–ª–æ ‚Äì –µ–¥–Ω–∞ –Ω–æ–≤–∞ –ø–æ—Å–æ–∫–∞ —Ç–µ —á–∞–∫–∞.",
        "üåç –ú–∞–ª–∫–∞ –ø—Ä–æ–º—è–Ω–∞ –≤ –ø–ª–∞–Ω–æ–≤–µ—Ç–µ –¥–Ω–µ—Å —â–µ –æ—Ç–≤–æ—Ä–∏ –≥–æ–ª—è–º —Ö–æ—Ä–∏–∑–æ–Ω—Ç."
    ],
    "–ö–æ–∑–∏—Ä–æ–≥": [
        "‚õ∞Ô∏è –ö–æ–∑–∏—Ä–æ–≥, —Å—Ç—ä–ø–∫–∞ –ø–æ —Å—Ç—ä–ø–∫–∞ –ø–∞–∫ —Å–∏ –Ω–∞–π-–≤–∏—Å–æ–∫–æ.",
        "üíº –î–Ω–µ—Å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞—Ç–∞ —Ç–∏ —Ä–∞–±–æ—Ç–∏ –∑–∞ –±—ä–¥–µ—â–æ—Ç–æ —Ç–∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ."
    ],
    "–í–æ–¥–æ–ª–µ–π": [
        "üí° –í–æ–¥–æ–ª–µ–π, —Å—Ç—Ä–∞–Ω–Ω–∞—Ç–∞ —Ç–∏ –∏–¥–µ—è –¥–Ω–µ—Å –µ —Ç–æ—á–Ω–æ —Ç–æ–≤–∞, –∫–æ–µ—Ç–æ —Å–≤–µ—Ç–∞ —á–∞–∫–∞.",
        "üå¨Ô∏è –ü—É—Å–Ω–∏ —Å—Ç–∞—Ä–∏—Ç–µ –º–∏—Å–ª–∏ ‚Äì –Ω–æ–≤ –≤—è—Ç—ä—Ä –∏–¥–≤–∞ –∫—ä–º —Ç–µ–±."
    ],
    "–†–∏–±–∏": [
        "üêö –†–∏–±–∏, –Ω–µ —Å–µ –∏–∑–≤–∏–Ω—è–≤–∞–π, —á–µ —á—É–≤—Å—Ç–≤–∞—à –¥—ä–ª–±–æ–∫–æ.",
        "üåä –ú—É–∑–∏–∫–∞, –º–µ—á—Ç–∏ –∏ —Ç–∏—à–∏–Ω–∞ ‚Äì –¥–Ω–µ—Å —Å–∞ —Ç–≤–æ–µ—Ç–æ –≥–æ—Ä–∏–≤–æ."
    ],
}

GENERIC_DAILY = [
    "‚ú® –î–Ω–µ—Å –í—Å–µ–ª–µ–Ω–∞—Ç–∞ —Ç–∏ –Ω–∞–º–∏–≥–≤–∞. –í–∏–∂ –∫—ä–¥–µ.",
    "üíõ –ú–∞–ª–∫–∞ –∫—Ä–∞—á–∫–∞ –≤ —Ç–≤–æ–µ –∏–º–µ –µ –≥–æ–ª—è–º –∂–µ—Å—Ç –∫—ä–º –±—ä–¥–µ—â–æ—Ç–æ —Ç–∏ –∞–∑.",
    "üåü –¢–æ—á–Ω–æ —Å–µ–≥–∞ –Ω—è–∫–æ–π –º–∏—Å–ª–∏ –¥–æ–±—Ä–æ –∑–∞ —Ç–µ–±. –ü–æ–∑–≤–æ–ª–∏ —Å–∏ –¥–∞ –≥–æ —É—Å–µ—Ç–∏—à."
]

# –ü—Ä–∏–º–µ—Ä–Ω–∏ —Ç–µ–∫—Å—Ç–æ–≤–µ –∑–∞ –ø–ª–∞—Ç–µ–Ω–∏—è —Å–µ–¥–º–∏—á–µ–Ω —Ö–æ—Ä–æ—Å–∫–æ–ø
def generate_weekly_text(sign: str) -> str:
    templates = [
        f"‚ú® –°–µ–¥–º–∏—Ü–∞—Ç–∞ –∑–∞ {sign} –Ω–æ—Å–∏ –ø–æ-—Å–ø–æ–∫–æ–π–Ω–∞ –µ–Ω–µ—Ä–≥–∏—è. "
        "–í—Ä–µ–º–µ –µ –¥–∞ –ø–æ–¥—Ä–µ–¥–∏—à –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∏—Ç–µ —Å–∏ –∏ –¥–∞ –∫–∞–∂–µ—à —Ç–≤—ä—Ä–¥–æ '–Ω–µ' –Ω–∞ —Ç–æ–≤–∞, "
        "–∫–æ–µ—Ç–æ –≤–µ—á–µ –Ω–µ —Ç–∏ —Å–ª—É–∂–∏.",

        f"üåô –ó–∞ {sign} —Ç–∞–∑–∏ —Å–µ–¥–º–∏—Ü–∞ —Ñ–æ–∫—É—Å—ä—Ç –µ –≤—ä—Ä—Ö—É –æ—Ç–Ω–æ—à–µ–Ω–∏—è—Ç–∞. "
        "–ì–æ–≤–æ—Ä–∏ —á–µ—Å—Ç–Ω–æ, –Ω–æ –º–µ–∫–æ. –ß—É–π –∫–∞–∫–≤–æ –∫–∞–∑–≤–∞—Ç –∏ –∂–µ—Å—Ç–æ–≤–µ—Ç–µ, –Ω–µ —Å–∞–º–æ –¥—É–º–∏—Ç–µ.",

        f"üî• {sign}, –∏–¥–≤–∞ —Å–µ–¥–º–∏—Ü–∞ –Ω–∞ –¥–≤–∏–∂–µ–Ω–∏–µ. –ê–∫–æ –æ—Ç–¥–∞–≤–Ω–∞ –æ—Ç–ª–∞–≥–∞—à –Ω–µ—â–æ ‚Äì "
        "–Ω–∞–ø—Ä–∞–≤–∏ –ø—ä—Ä–≤–∞—Ç–∞ –∫—Ä–∞—á–∫–∞. –í—Å–µ–ª–µ–Ω–∞—Ç–∞ —â–µ –æ—Ç–≥–æ–≤–æ—Ä–∏."
    ]
    return random.choice(templates)


# === –ü–æ–º–æ—â–Ω–∏ –Ω–µ—â–∞ –∑–∞ –º–µ–Ω—é –∏ —Å—ä—Å—Ç–æ—è–Ω–∏–µ ===

user_state = {}  # {chat_id: {...}}

def main_menu_keyboard():
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.row("üîÆ –•–æ—Ä–æ—Å–∫–æ–ø", "üíå –ü–æ—Å–ª–∞–Ω–∏–µ")
    kb.row("‚ÑπÔ∏è –ü–æ–º–æ—â")
    return kb


# === –ö–æ–º–∞–Ω–¥–∏ /start –∏ /help ===

@bot.message_handler(commands=["start", "hello"])
def send_welcome(message):
    text = (
        "üå∏ –ó–¥—Ä–∞–≤–µ–π, –∞–∑ —Å—ä–º –õ–∏–æ—Ä–∞.\n"
        "–û–±–∏—á–∞–º –¥–∞ –Ω–æ—Å—è —è—Å–Ω–æ—Ç–∞, –Ω–µ–∂–Ω–æ—Å—Ç –∏ –º–∞–ª–∫–æ —à–µ–≥–∏.\n\n"
        "–ú–æ–≥–∞ –¥–∞ —Ç–∏ –¥–∞–º:\n"
        "‚Ä¢ –±–µ–∑–ø–ª–∞—Ç–µ–Ω —Ö–æ—Ä–æ—Å–∫–æ–ø –∑–∞ –¥–µ–Ω—è\n"
        "‚Ä¢ –ø–ª–∞—Ç–µ–Ω —Å–µ–¥–º–∏—á–µ–Ω —Ö–æ—Ä–æ—Å–∫–æ–ø\n"
        "‚Ä¢ –ª–∏—á–Ω–æ –ø–æ—Å–ª–∞–Ω–∏–µ –∑–∞ –¥—É—à–∞—Ç–∞ —Ç–∏\n\n"
        "–ò–∑–±–µ—Ä–∏ –æ—Ç –º–µ–Ω—é—Ç–æ –ø–æ-–¥–æ–ª—É. üí´"
    )
    bot.send_message(message.chat.id, text, reply_markup=main_menu_keyboard())


@bot.message_handler(commands=["help"])
def send_help(message):
    text = (
        "‚ÑπÔ∏è –ü–æ–º–æ—â\n\n"
        "üîÆ ‚Äû–•–æ—Ä–æ—Å–∫–æ–ø‚Äú ‚Äì –∏–∑–±–∏—Ä–∞—à –∑–æ–¥–∏—è –∏ –ø–µ—Ä–∏–æ–¥.\n"
        "   ‚Ä¢ –î–Ω–µ—Å ‚Äì –±–µ–∑–ø–ª–∞—Ç–Ω–æ\n"
        "   ‚Ä¢ –°–µ–¥–º–∏—Ü–∞ ‚Äì –ø–ª–∞—Ç–µ–Ω–æ, —á—Ä–µ–∑ Telegram –ø–ª–∞—â–∞–Ω–µ.\n\n"
        "üíå ‚Äû–ü–æ—Å–ª–∞–Ω–∏–µ‚Äú ‚Äì –∫—Ä–∞—Ç–∫–æ –Ω–µ–∂–Ω–æ –ø–æ—Å–ª–∞–Ω–∏–µ –æ—Ç –º–µ–Ω.\n\n"
        "–° –≤—Ä–µ–º–µ—Ç–æ —â–µ –¥–æ–±–∞–≤—è–º–µ –æ—â–µ –º–∞–≥–∏–∏. ‚ú®"
    )
    bot.send_message(message.chat.id, text, reply_markup=main_menu_keyboard())


# === –•–æ—Ä–æ—Å–∫–æ–ø ‚Äì —Å—Ç–∞—Ä—Ç ===

@bot.message_handler(func=lambda m: m.text == "üîÆ –•–æ—Ä–æ—Å–∫–æ–ø")
def horoscope_start(message):
    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    row = []
    for i, sign in enumerate(ZODIAC_SIGNS, start=1):
        row.append(sign)
        if i % 3 == 0:
            kb.row(*row)
            row = []
    if row:
        kb.row(*row)
    kb.row("‚¨ÖÔ∏è –ù–∞–∑–∞–¥")
    user_state[message.chat.id] = {"step": "choose_sign"}
    bot.send_message(message.chat.id, "–ò–∑–±–µ—Ä–∏ –∑–æ–¥–∏—è:", reply_markup=kb)


@bot.message_handler(func=lambda m: user_state.get(m.chat.id, {}).get("step") == "choose_sign")
def horoscope_choose_period(message):
    chat_id = message.chat.id
    text = message.text.strip()

    if text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥":
        user_state.pop(chat_id, None)
        bot.send_message(chat_id, "–í—ä—Ä–Ω–∞—Ö —Ç–µ –≤ –Ω–∞—á–∞–ª–æ—Ç–æ. üí´", reply_markup=main_menu_keyboard())
        return

    if text not in ZODIAC_SIGNS:
        bot.send_message(chat_id, "–ú–æ–ª—è, –∏–∑–±–µ—Ä–∏ –∑–æ–¥–∏—è –æ—Ç —Å–ø–∏—Å—ä–∫–∞ –∏–ª–∏ ‚Äû‚¨ÖÔ∏è –ù–∞–∑–∞–¥‚Äú.")
        return

    user_state[chat_id] = {"step": "choose_period", "sign": text}

    kb = types.ReplyKeyboardMarkup(resize_keyboard=True)
    kb.row("‚òÄÔ∏è –î–Ω–µ—Å (–±–µ–∑–ø–ª–∞—Ç–Ω–æ)")
    kb.row("üìÖ –°–µ–¥–º–∏—Ü–∞ (–ø–ª–∞—Ç–µ–Ω–æ)")
    kb.row("‚¨ÖÔ∏è –ù–∞–∑–∞–¥")

    bot.send_message(
        chat_id,
        f"–ò–∑–±—Ä–∞ {text}. –°–µ–≥–∞ –∏–∑–±–µ—Ä–∏ –ø–µ—Ä–∏–æ–¥:",
        reply_markup=kb
    )


@bot.message_handler(func=lambda m: user_state.get(m.chat.id, {}).get("step") == "choose_period")
def horoscope_handle_period(message):
    chat_id = message.chat.id
    state = user_state.get(chat_id, {})
    sign = state.get("sign")
    text = message.text.strip()

    if text == "‚¨ÖÔ∏è –ù–∞–∑–∞–¥":
        # –í—Ä—ä—â–∞–º–µ –∫—ä–º –∏–∑–±–æ—Ä–∞ –Ω–∞ –∑–æ–¥–∏—è
        user_state[chat_id] = {"step": "choose_sign"}
        horoscope_start(message)
        return

    if "–î–Ω–µ—Å" in text:
        # –ë–µ–∑–ø–ª–∞—Ç–µ–Ω —Ö–æ—Ä–æ—Å–∫–æ–ø –∑–∞ –¥–µ–Ω—è
        messages = DAILY_MESSAGES.get(sign) or GENERIC_DAILY
        daily_text = random.choice(messages)
        bot.send_message(
            chat_id,
            f"‚òÄÔ∏è –î–Ω–µ—à–µ–Ω —Ö–æ—Ä–æ—Å–∫–æ–ø –∑–∞ {sign}:\n\n{daily_text}",
            reply_markup=main_menu_keyboard()
        )
        user_state.pop(chat_id, None)
        return

    if "–°–µ–¥–º–∏—Ü–∞" in text:
        # –ü–ª–∞—Ç–µ–Ω —Å–µ–¥–º–∏—á–µ–Ω —Ö–æ—Ä–æ—Å–∫–æ–ø ‚Äì —Å—ä–∑–¥–∞–≤–∞–º–µ —Ñ–∞–∫—Ç—É—Ä–∞
        price_stotinki = 399  # 3.99 –ª–≤ ‚Äì –ø—Ä–æ–º–µ–Ω–∏, –∞–∫–æ –∏—Å–∫–∞—à
        prices = [types.LabeledPrice(
            label=f"–°–µ–¥–º–∏—á–µ–Ω —Ö–æ—Ä–æ—Å–∫–æ–ø –∑–∞ {sign}",
            amount=price_stotinki
        )]

        bot.send_invoice(
            chat_id=chat_id,
            title=f"–°–µ–¥–º–∏—á–µ–Ω —Ö–æ—Ä–æ—Å–∫–æ–ø ‚Äì {sign}",
            description=(
                f"–ü–æ–¥—Ä–æ–±–µ–Ω –µ–º–æ—Ü–∏–æ–Ω–∞–ª–µ–Ω —Ö–æ—Ä–æ—Å–∫–æ–ø –∑–∞ {sign} "
                "–∑–∞ —Å–ª–µ–¥–≤–∞—â–∏—Ç–µ 7 –¥–Ω–∏. –î–µ–ª–∏–∫–∞—Ç–Ω–æ—Å—Ç, –Ω–∞—Å–æ–∫–∏ –∏ –º–∞–ª–∫–æ –º–∞–≥–∏—è. ‚ú®"
            ),
            provider_token=PROVIDER_TOKEN,
            currency="BGN",
            prices=prices,
            start_parameter="weekly_horoscope",
            invoice_payload=f"weekly:{sign}"  # —â–µ –≥–æ —Ä–∞–∑—á–µ—Ç–µ–º –ø–æ—Å–ª–µ
        )

        user_state[chat_id]["step"] = "waiting_payment"
        return

    bot.send_message(chat_id, "–ú–æ–ª—è, –∏–∑–±–µ—Ä–∏ –µ–¥–Ω–∞ –æ—Ç –æ–ø—Ü–∏–∏—Ç–µ –∏–ª–∏ ‚Äû‚¨ÖÔ∏è –ù–∞–∑–∞–¥‚Äú.")


# === Telegram Payments ‚Äì –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–∏ —Ö–µ–Ω–¥–ª—ä—Ä–∏ ===

@bot.pre_checkout_query_handler(func=lambda q: True)
def checkout(pre_checkout_query):
    # –ê–∫–æ –≤—ä—Ä–Ω–µ–º ok=False ‚Äì –ø–ª–∞—â–∞–Ω–µ—Ç–æ —Å–µ —Å–ø–∏—Ä–∞
    bot.answer_pre_checkout_query(pre_checkout_query.id, ok=True)


@bot.message_handler(content_types=["successful_payment"])
def got_payment(message):
    chat_id = message.chat.id
    payload = message.successful_payment.invoice_payload or ""

    if payload.startswith("weekly:"):
        sign = payload.split(":", 1)[1]
        weekly_text = generate_weekly_text(sign)
        bot.send_message(
            chat_id,
            f"üåô –°–µ–¥–º–∏—á–µ–Ω —Ö–æ—Ä–æ—Å–∫–æ–ø –∑–∞ {sign}:\n\n{weekly_text}",
            reply_markup=main_menu_keyboard()
        )
        user_state.pop(chat_id, None)
        return

    # –ó–∞ –±—ä–¥–µ—â–∏ –ø–ª–∞—Ç–µ–Ω–∏ —É—Å–ª—É–≥–∏:
    bot.send_message(chat_id, "–ü–ª–∞—â–∞–Ω–µ—Ç–æ –µ –ø–æ–ª—É—á–µ–Ω–æ. –ë–ª–∞–≥–æ–¥–∞—Ä—è —Ç–∏! üíõ")


# === –ü—Ä–æ—Å—Ç–∏ –ø–æ—Å–ª–∞–Ω–∏—è (–±–µ–∑–ø–ª–∞—Ç–Ω–∏) ===

@bot.message_handler(func=lambda m: m.text == "üíå –ü–æ—Å–ª–∞–Ω–∏–µ")
def free_message(message):
    texts = [
        "üíå –î—É–º–∏—Ç–µ —Ç–∏ –Ω–µ —Å–∞ —Å–ª—É—á–∞–π–Ω–∏. –ü—Ä–æ–¥—ä–ª–∂–∏.",
        "üå∑ –¢–æ–≤–∞, –∫–æ–µ—Ç–æ —Ç—ä—Ä—Å–∏—à, –º–æ–∂–µ –±–∏ –≤–µ—á–µ —Ç–µ —Ç—ä—Ä—Å–∏.",
        "üåü –ü–æ–Ω—è–∫–æ–≥–∞ –Ω–∞–π-–≥–æ–ª—è–º–∞—Ç–∞ —Å–º–µ–ª–æ—Å—Ç –µ –ø—Ä–æ—Å—Ç–æ –¥–∞ –æ—Å—Ç–∞–Ω–µ—à –≤—è—Ä–Ω–∞ –Ω–∞ —Å–µ–±–µ —Å–∏."
    ]
    bot.send_message(message.chat.id, random.choice(texts), reply_markup=main_menu_keyboard())


@bot.message_handler(func=lambda m: m.text == "‚ÑπÔ∏è –ü–æ–º–æ—â")
def help_button(message):
    send_help(message)


# === –û–±—â–æ fallback –ø–æ–≤–µ–¥–µ–Ω–∏–µ ===

@bot.message_handler(func=lambda m: True)
def fallback(message):
    # –ê–∫–æ —á–æ–≤–µ–∫ –Ω–∞–ø–∏—à–µ ‚Äû–∫–∞–∫ —Å–∏‚Äú –∏ —Ç.–Ω. ‚Äì –º–∞–ª–∫–æ –µ–º–ø–∞—Ç–∏—è:
    lower = (message.text or "").lower()

    if "–∫–∞–∫ —Å–∏" in lower:
        bot.reply_to(message, "üå∏ –¢–∏—Ö–æ –∏ —Å–≤–µ—Ç–ª–æ –º–∏ –µ. –ê –Ω–∞ —Ç–µ–± –∫–∞–∫ —Ç–∏ –µ –≤—ä—Ç—Ä–µ?")
        return

    bot.reply_to(
        message,
        "üåü –®–µ–ø–Ω–µ—à –º–∏ –Ω–µ—â–æ —Å–≤–æ–µ.\n"
        "–ó–∞ —Ö–æ—Ä–æ—Å–∫–æ–ø –∏–∑–±–µ—Ä–∏ ‚ÄûüîÆ –•–æ—Ä–æ—Å–∫–æ–ø‚Äú, –∑–∞ –Ω–µ–∂–Ω–∏ –¥—É–º–∏ ‚Äì ‚Äûüíå –ü–æ—Å–ª–∞–Ω–∏–µ‚Äú.",
        reply_markup=main_menu_keyboard()
    )


# === –°—Ç–∞—Ä—Ç –Ω–∞ –±–æ—Ç–∞ ===

if __name__ == "__main__":
    print("–õ–∏–æ—Ä–∞ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ —Å –ª—é–±–æ–≤. üí´")
    bot.polling(none_stop=True)
